name: ESP32S3 Build (IDF 6.0-dev)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Optional tag name to upload assets to a release (example 'v1.2.3')"
        required: false
      rebuild_release:
        description: "Delete existing assets for the tag before uploading (rebuild release)"
        required: false
        type: choice
        options:
          - "false"
          - "true"
        default: "false"
      build_pages:
        description: "Build and deploy GitHub Pages"
        required: false
        type: choice
        options:
          - "false"
          - "true"
        default: "false"
  push:
    branches: [main, master]
    paths:
      - 'main/main.c'
      - '.github/scripts/**'
      - '.github/workflows/esp32s3-build-master.yml'
  release:
    types: [published, edited]

jobs:
  build:
    name: Build ${{ matrix.board }}
    permissions:
      contents: read
    runs-on: ubuntu-24.04
    container:
      image: espressif/idf:v6.0-beta1
    strategy:
      fail-fast: false
      matrix:
        board: [adv, k132]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache ESP-IDF artifacts
        uses: actions/cache@v4
        with:
          path: /root/.espressif
          key: espidf-6.0-${{ runner.os }}-${{ hashFiles('sdkconfig', 'dependencies.lock') }}
          restore-keys: |
            espidf-6.0-${{ runner.os }}-
            espidf-6.0-

      - name: Build JanOS (IDF 6.0)
        env:
          BOARD_LIST: ${{ matrix.board }}
        run: IDF_PY_FLAGS="--preview" bash .github/scripts/container_build.sh --no-docker

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32s3-firmware-${{ matrix.board }}
          path: binaries-esp32s3/${{ matrix.board }}
          if-no-files-found: error

  package:
    name: Package Release Artifacts
    needs: [build]
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    outputs:
      fw_version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download ADV artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware-adv
          path: release_artifacts/firmware/adv

      - name: Download K132 artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware-k132
          path: release_artifacts/firmware/k132

      - name: Stamp JanOS with JANOS_ADV_VERSION
        id: version
        run: |
          set -e
          version=$(python - <<'PY'
          from pathlib import Path
          import re
          text = Path("main/main.c").read_text()
          m = re.search(r'JANOS_ADV_VERSION\s*"([^"]+)"', text)
          if not m:
              raise SystemExit("JANOS_ADV_VERSION not found")
          print(m.group(1))
          PY
          )
          for board in adv k132; do
            src_dir="release_artifacts/firmware/${board}"
            src="${src_dir}/M5MonsterC5-CardputerADV.bin"
            if [ ! -f "$src" ]; then
              echo "Missing firmware: $src" >&2
              exit 1
            fi
            cp "binaries-esp32s3/flash_board.py" "${src_dir}/flash_board.py"
            cp "${src_dir}/bootloader.bin" "${src_dir}/bootloader-${board}.bin"
            cp "${src_dir}/partition-table.bin" "${src_dir}/partition-table-${board}.bin"
            cp "$src" "${src_dir}/M5MonsterC5-CardputerADV-${board}.bin"
            cp "$src" "${src_dir}/M5MonsterC5-CardputerADV-${board}-${version}.bin"
            cp "$src" "${src_dir}/M5MonsterC5-CardputerADV-${board}-launcher.bin"
            cp "$src" "${src_dir}/M5MonsterC5-CardputerADV-${board}-launcher-${version}.bin"
          done
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Merge full flash image
        shell: bash
        run: |
          set -euo pipefail
          if ! python3 -c "import venv" >/dev/null 2>&1; then
            apt-get update
            apt-get install -y python3-venv
          fi
          python3 -m venv /tmp/esptool-venv
          /tmp/esptool-venv/bin/python -m pip install --no-cache-dir esptool
          for board in adv k132; do
            out_dir="release_artifacts/firmware/${board}"
            /tmp/esptool-venv/bin/python -m esptool --chip esp32s3 merge_bin -o "${out_dir}/M5MonsterC5-CardputerADV-${board}-full-${{ steps.version.outputs.version }}.bin" \
              --flash_mode dio --flash_freq 80m --flash_size 4MB \
              0x0 "${out_dir}/bootloader.bin" \
              0x8000 "${out_dir}/partition-table.bin" \
              0x10000 "${out_dir}/M5MonsterC5-CardputerADV.bin"
            cp "${out_dir}/M5MonsterC5-CardputerADV-${board}-full-${{ steps.version.outputs.version }}.bin" \
              "${out_dir}/M5MonsterC5-CardputerADV-${board}-full.bin"
          done

      - name: Package JanOS bundles
        id: bundle
        run: |
          set -e
          for board in adv k132; do
            cd "release_artifacts/firmware/${board}"
            out="M5MonsterC5-CardputerADV-${board}-${{ steps.version.outputs.version }}.zip"
            rm -f "$out"
            zip -9 "$out" \
              "bootloader-${board}.bin" \
              "partition-table-${board}.bin" \
              flash_board.py \
              "M5MonsterC5-CardputerADV-${board}-full.bin" \
              "M5MonsterC5-CardputerADV-${board}-full-${{ steps.version.outputs.version }}.bin" \
              "M5MonsterC5-CardputerADV-${board}.bin" \
              "M5MonsterC5-CardputerADV-${board}-${{ steps.version.outputs.version }}.bin" \
              "M5MonsterC5-CardputerADV-${board}-launcher.bin" \
              "M5MonsterC5-CardputerADV-${board}-launcher-${{ steps.version.outputs.version }}.bin"
            cd - >/dev/null
          done

      - name: Upload JanOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32s3-firmware
          path: release_artifacts/firmware
          if-no-files-found: error

  release:
    name: Release
    needs: [package]
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
    steps:
      - name: Resolve release tag
        id: meta
        env:
          EVENT_TAG: ${{ github.event.release.tag_name }}
          INPUT_TAG: ${{ inputs.release_tag }}
          FW_VERSION: ${{ needs.package.outputs.fw_version }}
        run: |
          set -euo pipefail
          TAG="${EVENT_TAG:-}"
          if [ -z "$TAG" ]; then TAG="${INPUT_TAG:-}"; fi
          if [ -z "$TAG" ]; then TAG="v${FW_VERSION}"; fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Download JanOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
          path: release_artifacts/firmware

      - name: Package full bundle (JANOS)
        run: |
          set -e
          cd release_artifacts
          mkdir -p bundle
          FW_VERSION="${{ needs.package.outputs.fw_version }}"

          shopt -s nullglob

          for board in adv k132; do
            files=(
              "firmware/${board}/bootloader-${board}.bin"
              "firmware/${board}/partition-table-${board}.bin"
              "firmware/flash_board.py"
              "firmware/${board}/M5MonsterC5-CardputerADV-${board}-full.bin"
              "firmware/${board}/M5MonsterC5-CardputerADV-${board}-full-${FW_VERSION}.bin"
              "firmware/${board}/M5MonsterC5-CardputerADV-${board}.bin"
              "firmware/${board}/M5MonsterC5-CardputerADV-${board}-${FW_VERSION}.bin"
              "firmware/${board}/M5MonsterC5-CardputerADV-${board}-launcher-${FW_VERSION}.bin"
              "firmware/${board}/M5MonsterC5-CardputerADV-${board}-launcher.bin"
              "firmware/${board}/M5MonsterC5-CardputerADV-${board}-${FW_VERSION}.zip"
            )
            out="bundle/M5MonsterC5-CardputerADV-${board}-${FW_VERSION}.zip"
            rm -f "$out"
            zip -9 "$out" "${files[@]}"
          done

      - name: Upload binaries to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ format('M5MonsterC5-CardputerADV {0}', needs.package.outputs.fw_version) }}
          overwrite: true
          files: |
            release_artifacts/firmware/flash_board.py
            release_artifacts/firmware/adv/bootloader-adv.bin
            release_artifacts/firmware/adv/partition-table-adv.bin
            release_artifacts/firmware/adv/M5MonsterC5-CardputerADV-adv-full.bin
            release_artifacts/firmware/adv/M5MonsterC5-CardputerADV-adv-full-${{ needs.package.outputs.fw_version }}.bin
            release_artifacts/firmware/adv/M5MonsterC5-CardputerADV-adv.bin
            release_artifacts/firmware/adv/M5MonsterC5-CardputerADV-adv-${{ needs.package.outputs.fw_version }}.bin
            release_artifacts/firmware/adv/M5MonsterC5-CardputerADV-adv-launcher.bin
            release_artifacts/firmware/adv/M5MonsterC5-CardputerADV-adv-launcher-${{ needs.package.outputs.fw_version }}.bin
            release_artifacts/firmware/adv/M5MonsterC5-CardputerADV-adv-${{ needs.package.outputs.fw_version }}.zip
            release_artifacts/firmware/k132/bootloader-k132.bin
            release_artifacts/firmware/k132/partition-table-k132.bin
            release_artifacts/firmware/k132/M5MonsterC5-CardputerADV-k132-full.bin
            release_artifacts/firmware/k132/M5MonsterC5-CardputerADV-k132-full-${{ needs.package.outputs.fw_version }}.bin
            release_artifacts/firmware/k132/M5MonsterC5-CardputerADV-k132.bin
            release_artifacts/firmware/k132/M5MonsterC5-CardputerADV-k132-${{ needs.package.outputs.fw_version }}.bin
            release_artifacts/firmware/k132/M5MonsterC5-CardputerADV-k132-launcher.bin
            release_artifacts/firmware/k132/M5MonsterC5-CardputerADV-k132-launcher-${{ needs.package.outputs.fw_version }}.bin
            release_artifacts/firmware/k132/M5MonsterC5-CardputerADV-k132-${{ needs.package.outputs.fw_version }}.zip
            release_artifacts/bundle/M5MonsterC5-CardputerADV-adv-${{ needs.package.outputs.fw_version }}.zip
            release_artifacts/bundle/M5MonsterC5-CardputerADV-k132-${{ needs.package.outputs.fw_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  pages:
    name: Pages Web Flasher
    needs: [release, package]
    if: ${{ needs.release.result == 'success' && (github.event_name != 'workflow_dispatch' || inputs.build_pages == 'true') }}
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Resolve release tag
        id: meta
        env:
          EVENT_TAG: ${{ github.event.release.tag_name }}
          INPUT_TAG: ${{ inputs.release_tag }}
          FW_VERSION: ${{ needs.package.outputs.fw_version }}
        run: |
          set -euo pipefail
          TAG="${EVENT_TAG:-}"
          if [ -z "$TAG" ]; then TAG="${INPUT_TAG:-}"; fi
          if [ -z "$TAG" ]; then TAG="v${FW_VERSION}"; fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using tag: $TAG"

      - name: Download release assets
        id: download
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.meta.outputs.tag }}"
          rm -rf docs/firmware
          mkdir -p docs/firmware/tmp

          gh release download "$TAG" -R "$GITHUB_REPOSITORY" --dir docs/firmware/tmp \
            --pattern "bootloader-adv.bin" \
            --pattern "partition-table-adv.bin" \
            --pattern "M5MonsterC5-CardputerADV-adv*.bin" \
            --pattern "bootloader-k132.bin" \
            --pattern "partition-table-k132.bin" \
            --pattern "M5MonsterC5-CardputerADV-k132*.bin"

          mkdir -p docs/firmware/adv docs/firmware/k132

          cp docs/firmware/tmp/bootloader-adv.bin docs/firmware/adv/bootloader.bin
          cp docs/firmware/tmp/partition-table-adv.bin docs/firmware/adv/partition-table.bin
          cp docs/firmware/tmp/M5MonsterC5-CardputerADV-adv.bin docs/firmware/adv/M5MonsterC5-CardputerADV.bin

          cp docs/firmware/tmp/bootloader-k132.bin docs/firmware/k132/bootloader.bin
          cp docs/firmware/tmp/partition-table-k132.bin docs/firmware/k132/partition-table.bin
          cp docs/firmware/tmp/M5MonsterC5-CardputerADV-k132.bin docs/firmware/k132/M5MonsterC5-CardputerADV.bin

          ls -lh docs/firmware/adv docs/firmware/k132

          for board in adv k132; do
            for f in bootloader.bin partition-table.bin M5MonsterC5-CardputerADV.bin; do
              if [ ! -f "docs/firmware/${board}/$f" ]; then
                echo "Missing $f for ${board} in release assets for tag ${TAG}" >&2
                exit 1
              fi
            done
          done

          fw_version=$(ls docs/firmware/tmp/M5MonsterC5-CardputerADV-adv-*.bin 2>/dev/null | head -n1 | xargs -n1 basename | sed -E 's/^M5MonsterC5-CardputerADV-adv-([^.]*)\\.bin$/\\1/')
          if [ -z "$fw_version" ]; then
            fw_version="${TAG}"
          fi
          echo "fw_version=$fw_version" >> "$GITHUB_OUTPUT"

      - name: Build manifest.json
        env:
          FW_VERSION: ${{ steps.download.outputs.fw_version }}
          BUILD_TAG: ${{ steps.meta.outputs.tag }}
        run: |
          set -euo pipefail
          python -c "import os, json; from pathlib import Path; version=os.getenv('FW_VERSION') or os.getenv('BUILD_TAG'); build=os.getenv('BUILD_TAG','manual'); base={'version':version,'build':build,'chipFamily':'ESP32-S3'}; adv={'name':'M5MonsterC5-CardputerADV ESP32-S3 (ADV)','parts':[{'path':'firmware/adv/bootloader.bin','offset':8192},{'path':'firmware/adv/partition-table.bin','offset':32768},{'path':'firmware/adv/M5MonsterC5-CardputerADV.bin','offset':65536}]}; k132={'name':'M5MonsterC5-CardputerADV ESP32-S3 (K132)','parts':[{'path':'firmware/k132/bootloader.bin','offset':8192},{'path':'firmware/k132/partition-table.bin','offset':32768},{'path':'firmware/k132/M5MonsterC5-CardputerADV.bin','offset':65536}]}; Path('docs/manifest.json').write_text(json.dumps({**base, **adv}, indent=2)); Path('docs/manifest_k132.json').write_text(json.dumps({**base, **k132}, indent=2))"
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  discord:
    name: Discord
    needs: [release, package, pages]
    runs-on: ubuntu-24.04
    steps:
      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.GIT_BUILD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FW_VERSION: ${{ needs.package.outputs.fw_version }}
          RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag || format('v{0}', needs.firmware.outputs.fw_version) }}
          REPO: ${{ github.repository }}
          PAGES_URL: ${{ needs.pages.outputs.page_url || format('https://{0}.github.io/{1}/', github.repository_owner, github.event.repository.name) }}
        run: |
          set -e
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK not configured, skipping notification"
            exit 0
          fi
          TAG="${RELEASE_TAG:-$FW_VERSION}"
          BASE_URL="https://github.com/$REPO/releases/download/$TAG"
          FW_ADV_BIN="$BASE_URL/M5MonsterC5-CardputerADV-adv-${FW_VERSION}.bin"
          FW_K132_BIN="$BASE_URL/M5MonsterC5-CardputerADV-k132-${FW_VERSION}.bin"
          LAUNCHER_ADV_BIN="$BASE_URL/M5MonsterC5-CardputerADV-adv-launcher-${FW_VERSION}.bin"
          LAUNCHER_K132_BIN="$BASE_URL/M5MonsterC5-CardputerADV-k132-launcher-${FW_VERSION}.bin"
          FULL_ADV_BIN="$BASE_URL/M5MonsterC5-CardputerADV-adv-full-${FW_VERSION}.bin"
          FULL_K132_BIN="$BASE_URL/M5MonsterC5-CardputerADV-k132-full-${FW_VERSION}.bin"
          ZIP_ADV="$BASE_URL/M5MonsterC5-CardputerADV-adv-${FW_VERSION}.zip"
          ZIP_K132="$BASE_URL/M5MonsterC5-CardputerADV-k132-${FW_VERSION}.zip"
          RELEASE_PAGE="https://github.com/$REPO/releases/tag/$TAG"
          PAGES_LINK="${PAGES_URL:-https://${GITHUB_REPOSITORY%/*}.github.io/${GITHUB_REPOSITORY#*/}/}"
          RELEASE_BODY=$(gh release view "$TAG" -R "$REPO" --json body --jq .body 2>/dev/null || true)
          if [ -n "$RELEASE_BODY" ]; then
            RELEASE_BODY="$(printf '%s' "$RELEASE_BODY" | tr -d '\r' | head -c 1800)"
          fi

          content=$(
            printf '%s\n' \
              "M5MonsterC5-CardputerADV" \
              "Release ${TAG} published." \
              "Release page:" \
              "${RELEASE_PAGE}" \
              "Web flasher:" \
              "${PAGES_LINK}" \
              "ADV firmware (${FW_VERSION}):" \
              "${FW_ADV_BIN}" \
              "ADV launcher:" \
              "${LAUNCHER_ADV_BIN}" \
              "ADV full image:" \
              "${FULL_ADV_BIN}" \
              "ADV ZIP:" \
              "${ZIP_ADV}" \
              "K132 firmware (${FW_VERSION}):" \
              "${FW_K132_BIN}" \
              "K132 launcher:" \
              "${LAUNCHER_K132_BIN}" \
              "K132 full image:" \
              "${FULL_K132_BIN}" \
              "K132 ZIP:" \
              "${ZIP_K132}" \
              "${RELEASE_BODY}"
          )
          payload=$(jq -n --arg content "$content" '{content:$content}')
          curl -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK"
